<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calories — Mint Tracker</title>
<meta name="theme-color" content="#2ed3a8"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --mint-50:#edfff8; --mint-100:#d7ffef; --mint-200:#b9ffe3; --mint-300:#8ef7d1; --mint-400:#5ce7bd; --mint-500:#2ed3a8;
  --mint-600:#15b893; --mint-700:#10937a; --mint-800:#0c7361; --mint-900:#0a5b4e;
  --bg:#0b1220; --surf:#0f172a; --surf-2:rgba(15,23,42,.7);
  --text:#e6f6f0; --muted:#a7c3bb; --ring:var(--mint-400);
  --radius-xl:18px; --radius-2xl:26px;
  --shadow-1:0 8px 20px rgba(0,0,0,.25); --shadow-2:0 20px 40px rgba(0,0,0,.35);
  --ease:cubic-bezier(.2,.7,.2,1); --speed:.45s;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:
  radial-gradient(1100px 600px at 0% 0%, rgba(46,211,168,.12), transparent 60%),
  radial-gradient(900px 500px at 100% 10%, rgba(16,147,122,.12), transparent 60%),
  linear-gradient(180deg,#0a1220 0%,#09121d 100%);
  overflow-x:hidden;
}
.container{width:min(1160px,94vw);margin:0 auto}
a{text-decoration:none;color:var(--text)}
.btn{
  display:inline-flex;align-items:center;gap:.6rem;padding:.85rem 1rem;border-radius:999px;border:1px solid rgba(255,255,255,.08);
  background:linear-gradient(180deg,var(--mint-500),var(--mint-600));color:#06231d;font-weight:800;letter-spacing:.02em;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.25),0 10px 20px rgba(46,211,168,.25);
  transition:transform .2s var(--ease),box-shadow .2s var(--ease),filter .2s var(--ease);cursor:pointer;
}
.btn:hover{transform:translateY(-2px);box-shadow:0 16px 28px rgba(46,211,168,.35)}
.btn--ghost{background:transparent;color:var(--text);border-color:#2b374a;box-shadow:none}
.chip{display:inline-block;padding:.38rem .7rem;border-radius:999px;background:linear-gradient(180deg,var(--mint-200),var(--mint-300));color:#06382e;font-weight:800;font-size:.8rem}

.nav{
  position:sticky;top:0;z-index:50;backdrop-filter:blur(14px);
  background:linear-gradient(180deg,rgba(15,23,42,.7),rgba(15,23,42,.35));border-bottom:1px solid rgba(255,255,255,.06)
}
.nav__in{display:flex;align-items:center;justify-content:space-between;padding:.7rem .8rem}
.brand{display:flex;align-items:center;gap:.7rem}
.logo{width:34px;height:34px;border-radius:12px;display:grid;place-items:center;background:conic-gradient(from 210deg,var(--mint-400),var(--mint-700),var(--mint-500));box-shadow:0 6px 18px rgba(46,211,168,.35)}
.nav__links{display:flex;gap:.8rem;align-items:center}
.nav__links a{padding:.55rem .7rem;border-radius:10px;color:var(--muted)}
.nav__links a:hover{background:rgba(255,255,255,.06);color:var(--text)}
.hamburger{display:none;width:42px;height:42px;border-radius:12px;border:0;background:transparent;color:var(--text)}
@media(max-width:900px){.nav__links{display:none}.hamburger{display:inline-grid;place-items:center}.mobileMenu{position:fixed;inset:64px 12px auto 12px;display:none;padding:.8rem;border-radius:18px;background:rgba(15,23,42,.9);border:1px solid rgba(255,255,255,.08);box-shadow:var(--shadow-2)}.mobileMenu.open{display:block}.mobileMenu a{display:block;padding:.8rem;border-radius:12px}}
.container-hdr{padding:1.2rem 0 0}

.header{
  padding: clamp(1.6rem,6vw,3rem) 0 1rem;
}
.header h1{
  font-size: clamp(1.9rem,4vw,3rem); margin:.2rem 0 .6rem; letter-spacing:-.02em; font-weight:900
}
.header p{color:var(--muted);max-width:60ch}

.tabs{margin-top:1rem;display:flex;gap:.5rem;flex-wrap:wrap}
.tab-btn{
  padding:.6rem .9rem;border-radius:999px;border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.05);color:var(--text);cursor:pointer;font-weight:700
}
.tab-btn.active{background:linear-gradient(180deg,var(--mint-400),var(--mint-600));color:#05261e;border-color:transparent}

.grid{display:grid;gap:1rem}
@media(min-width:980px){.grid-2{grid-template-columns:1.25fr .75fr}}
.card{
  background:linear-gradient(180deg,rgba(16,23,42,.65),rgba(16,23,42,.45)); border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius-2xl); padding:1rem; box-shadow:var(--shadow-1)
}
.card h3{margin:.2rem 0 .6rem}
.helper{color:var(--muted);font-size:.9rem}
.row{display:grid;grid-template-columns:1.2fr .5fr .5fr .5fr .3fr;gap:.5rem;align-items:center}
.row>div{display:flex;align-items:center}
.input, select{
  width:100%;padding:.8rem .9rem;border-radius:12px;background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.08);color:var(--text);outline:none;transition:border-color .2s
}
.input:focus, select:focus{border-color:var(--ring);box-shadow:0 0 0 3px rgba(46,211,168,.18)}
.small{font-size:.9rem}
.badge{display:inline-block;padding:.25rem .55rem;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);font-weight:800;font-size:.75rem}

.items{display:grid;gap:.6rem;margin-top:.8rem}
.item{
  display:grid;grid-template-columns:1fr .6fr .6fr .6fr .4fr;gap:.5rem;align-items:center;
  padding:.6rem;border-radius:14px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.03)
}
.item .remove{justify-self:end}
.kpi{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
.kpi .bar{height:10px;background:#1e293b;border:1px solid rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
.kpi .bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--mint-400),var(--mint-700));transition:width .8s var(--ease)}

.autocomplete{position:relative}
.suggest{
  position:absolute;top:100%;left:0;right:0;background:rgba(15,23,42,.98);border:1px solid rgba(255,255,255,.08);border-radius:12px;margin-top:.25rem;box-shadow:var(--shadow-2);display:none;max-height:240px;overflow:auto;z-index:30
}
.suggest.open{display:block}
.suggest div{padding:.6rem .7rem;cursor:pointer}
.suggest div:hover{background:rgba(255,255,255,.06)}

.hr{height:1px;background:rgba(255,255,255,.08);margin:.8rem 0}

.photo-wrap{display:grid;gap:1rem}
.cam{
  aspect-ratio: 4/3; border-radius:18px; overflow:hidden; background:#0c1527; border:1px solid rgba(255,255,255,.08);
  display:grid; place-items:center; position:relative
}
video, canvas{width:100%;height:100%;object-fit:cover}
.cam .overlay{position:absolute;inset:0;pointer-events:none;background:radial-gradient(600px 260px at 50% 10%, rgba(46,211,168,.12), transparent 60%)}
.controls{display:flex;gap:.5rem;flex-wrap:wrap}
.loader{display:none;gap:.5rem;align-items:center}
.loader.show{display:inline-flex}
.dot{width:8px;height:8px;border-radius:50%;background:var(--mint-400);animation:b 1.2s infinite ease-in-out}
.dot:nth-child(2){animation-delay:.12s}.dot:nth-child(3){animation-delay:.24s}
@keyframes b{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:.6rem;border-bottom:1px dashed rgba(255,255,255,.08);text-align:left;font-size:.95rem}
.right{text-align:right}
.total{font-weight:900}
.toast{
  position:fixed; bottom:16px; right:16px; background:rgba(15,23,42,.96); border:1px solid rgba(255,255,255,.12);
  padding:.8rem 1rem; border-radius:14px; display:none; box-shadow:var(--shadow-2); z-index:60
}
.toast.show{display:block;animation:fadeIn .25s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.skeleton{background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06));background-size:200% 100%;animation:sk 1.2s infinite}
@keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}

@media(prefers-reduced-motion:reduce){
  .btn,.kpi .bar>span{transition:none !important}
}
</style>
</head>
<body>

<!-- NAV -->
<header class="nav">
  <div class="container nav__in">
    <a class="brand" href="index.html">
      <div class="logo" aria-hidden="true"></div>
      <b>Mint Tracker</b>
    </a>
    <nav class="nav__links">
      <a href="weight-loss.html">Weight Loss</a>
      <a href="weight-gain.html">Weight Gain</a>
      <a href="calories.html" class="badge">Calories</a>
      <a href="exercises.html">Exercises</a>
      <a href="premium.html">Premium</a>
    </nav>
    <button class="hamburger" id="hamburger" aria-label="menu">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
  </div>
  <div class="mobileMenu" id="mobileMenu">
    <a href="weight-loss.html">Weight Loss</a>
    <a href="weight-gain.html">Weight Gain</a>
    <a href="calories.html">Calories</a>
    <a href="exercises.html">Exercises</a>
    <a href="premium.html">Premium</a>
  </div>
</header>

<div class="container container-hdr">
  <div class="header">
    <span class="chip">Two powerful ways</span>
    <h1>Calories & Macros — Manual + Photo</h1>
    <p>Type ingredients with amounts for instant totals, or snap a photo and let recognition estimate the plate. Export logs, see macro split, and save recent meals.</p>
    <div class="tabs" role="tablist" aria-label="Modes">
      <button class="tab-btn active" data-tab="manual" role="tab" aria-selected="true">Manual (type foods)</button>
      <button class="tab-btn" data-tab="photo" role="tab" aria-selected="false">Photo (camera or upload)</button>
    </div>
  </div>

  <div class="grid grid-2" id="panes">
    <!-- LEFT: PANEL -->
    <section class="card" id="panel">
      <!-- MANUAL MODE -->
      <div id="manualPane">
        <h3>Add ingredients</h3>
        <div class="row small" style="margin:.6rem 0 .4rem;opacity:.85">
          <div><b>Food</b></div>
          <div><b>Amount</b></div>
          <div><b>Unit</b></div>
          <div><b>kcal/100g</b></div>
          <div></div>
        </div>
        <div class="items" id="items"></div>

        <div class="hr"></div>
        <div class="controls">
          <button class="btn" id="addRow">Add row</button>
          <button class="btn btn--ghost" id="clearAll">Clear</button>
          <button class="btn btn--ghost" id="saveMeal">Save meal</button>
          <button class="btn btn--ghost" id="exportCsv">Export CSV</button>
        </div>
        <p class="helper" style="margin-top:.6rem">Tip: start typing to search foods. Switch units between grams, ml, or piece. API search is used if keys are set; otherwise a local database is used.</p>
      </div>

      <!-- PHOTO MODE -->
      <div id="photoPane" style="display:none">
        <h3>Recognize from photo</h3>
        <div class="photo-wrap">
          <div class="cam" id="cam">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas" style="display:none"></canvas>
            <div class="overlay"></div>
          </div>
          <div class="controls">
            <button class="btn" id="openCam">Open Camera</button>
            <button class="btn" id="snap">Capture</button>
            <label class="btn btn--ghost" for="filePick">Upload</label>
            <input id="filePick" type="file" accept="image/*" capture="environment" style="display:none"/>
            <span class="loader" id="loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Analyzing…</span>
          </div>
          <div id="photoResults" class="items"></div>
        </div>
        <div class="hr"></div>
        <div class="controls">
          <button class="btn btn--ghost" id="addPhotoToMeal">Add all to meal</button>
          <button class="btn btn--ghost" id="clearPhoto">Clear</button>
        </div>
        <p class="helper">This uses a food-recognition API if configured (best accuracy). Without a key, a local demo model estimates common items.</p>
      </div>
    </section>

    <!-- RIGHT: SUMMARY -->
    <aside class="card">
      <h3>Totals & macros</h3>
      <div class="kpi" style="margin:.5rem 0 1rem">
        <span class="badge">Today</span>
        <div class="bar" style="flex:1"><span id="macroP"></span></div>
        <div class="bar" style="flex:1"><span id="macroC"></span></div>
        <div class="bar" style="flex:1"><span id="macroF"></span></div>
      </div>
      <table class="table">
        <thead>
          <tr><th>Item</th><th class="right">Qty</th><th class="right">kcal</th><th class="right">P</th><th class="right">C</th><th class="right">F</th></tr>
        </thead>
        <tbody id="summaryBody">
          <tr><td colspan="6" class="helper">Add foods to see totals.</td></tr>
        </tbody>
        <tfoot>
          <tr class="total"><td>Total</td><td class="right" id="tQty">—</td><td class="right" id="tKcal">0</td><td class="right" id="tP">0g</td><td class="right" id="tC">0g</td><td class="right" id="tF">0g</td></tr>
        </tfoot>
      </table>

      <div class="hr"></div>
      <h3 style="margin-top:.4rem">Recent meals</h3>
      <div id="history" class="items small"></div>
    </aside>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ================== CONFIG (ADD YOUR API KEYS) ================== */
// Manual search APIs (choose any you have keys for)
const CONFIG = {
  // EDAMAM: https://developer.edamam.com/edamam-docs-nutrition-api
  EDAMAM_APP_ID: "", // TODO: ADD YOUR API KEYS
  EDAMAM_APP_KEY: "",

  // USDA FoodData Central: https://fdc.nal.usda.gov/api-guide.html
  USDA_API_KEY: "",

  // API Ninjas Nutrition (simple): https://api-ninjas.com/api/nutrition
  NINJAS_KEY: "",

  // Photo recognition (CalorieMama or similar)
  CALORIEMAMA_KEY: "", // e.g., "Bearer YOUR_KEY"
};

// Strategy flags (auto switches based on available keys)
const SEARCH_STRATEGY = () => {
  if (CONFIG.EDAMAM_APP_ID && CONFIG.EDAMAM_APP_KEY) return "edamam";
  if (CONFIG.USDA_API_KEY) return "usda";
  if (CONFIG.NINJAS_KEY) return "ninja";
  return "local";
};
const PHOTO_STRATEGY = () => {
  if (CONFIG.CALORIEMAMA_KEY) return "caloriemama";
  return "local";
};

/* ================== UTILITIES ================== */
const $ = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
const fmt = (n)=> (Math.round(n*10)/10).toString();
const toast = (msg)=>{ const t=$("#toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); };
const csvEscape = (s)=> `"${String(s).replace(/"/g,'""')}"`;

function debounce(fn, ms=220) {
  let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); };
}

/* ================== LOCAL FALLBACK DB (compact, expandable) ================== */
const LOCAL_DB = {
  // per 100g: kcal, protein g, carbs g, fat g
  foods: [
    {name:"Boiled rice", kcal:130, p:2.7, c:28, f:0.3},
    {name:"Chapati (roti)", kcal:297, p:9.6, c:56, f:5.1},
    {name:"Dal (lentil curry)", kcal:116, p:9, c:20, f:0.4},
    {name:"Paneer (cottage cheese)", kcal:296, p:18, c:6.1, f:22},
    {name:"Chicken breast (grilled)", kcal:165, p:31, c:0, f:3.6},
    {name:"Egg (boiled)", kcal:155, p:13, c:1.1, f:11},
    {name:"Milk (whole)", kcal:61, p:3.2, c:4.8, f:3.3},
    {name:"Banana", kcal:89, p:1.1, c:23, f:0.3},
    {name:"Apple", kcal:52, p:0.3, c:14, f:0.2},
    {name:"Pizza (cheese)", kcal:266, p:11, c:33, f:10},
    {name:"Burger (beef)", kcal:295, p:17, c:30, f:12},
    {name:"Samosa", kcal:262, p:5.3, c:31, f:13.4},
    {name:"Biryani (chicken)", kcal:240, p:12, c:32, f:7},
    {name:"Idli", kcal:146, p:5.2, c:28.1, f:2.7},
    {name:"Dosa (plain)", kcal:184, p:4.7, c:39, f:2.3},
    {name:"Upma", kcal:155, p:5, c:27, f:3.1},
    {name:"Poha", kcal:180, p:4, c:30, f:5},
    {name:"Maggi noodles (cooked)", kcal:211, p:5.4, c:37, f:5.6},
    {name:"Sushi (salmon roll)", kcal:200, p:8, c:28, f:6},
    {name:"Falafel", kcal:333, p:13, c:31, f:17},
    {name:"Pasta (cooked)", kcal:157, p:5.8, c:30, f:0.9},
    {name:"Oats (dry)", kcal:379, p:13.2, c:67.7, f:6.5},
    {name:"Peanut butter", kcal:588, p:25, c:20, f:50},
    {name:"Almonds", kcal:579, p:21, c:22, f:50},
    {name:"Curd (yogurt, plain)", kcal:61, p:3.5, c:4.7, f:3.3},
    {name:"Chole (chickpea curry)", kcal:180, p:9, c:27, f:4.5},
    {name:"Rajma (kidney bean curry)", kcal:142, p:8.7, c:26, f:0.5},
    {name:"Fish curry", kcal:150, p:18, c:5, f:6},
    {name:"Mutton curry", kcal:260, p:20, c:6, f:17},
    {name:"French fries", kcal:312, p:3.4, c:41, f:15},
  ]
};

/* ================== STATE ================== */
let items = []; // {id, name, qty, unit, kcal100, macros:{p,c,f}, kcal}
let photoDetections = []; // same schema
let history = JSON.parse(localStorage.getItem('calorie_history')||"[]").slice(0,25);

/* ================== NAV MOBILE ================== */
const hamburger = $("#hamburger"), mobileMenu=$("#mobileMenu");
hamburger?.addEventListener('click', ()=> mobileMenu.classList.toggle('open'));
document.addEventListener('click', (e)=>{ if(!mobileMenu.contains(e.target)&&!hamburger.contains(e.target)) mobileMenu.classList.remove('open'); });

/* ================== TABS ================== */
const panes = { manual: $("#manualPane"), photo: $("#photoPane") };
$$(".tab-btn").forEach(btn=>{
  btn.addEventListener('click', ()=>{
    $$(".tab-btn").forEach(b=> b.classList.remove('active')); btn.classList.add('active');
    panes.manual.style.display = btn.dataset.tab==="manual" ? "" : "none";
    panes.photo.style.display  = btn.dataset.tab==="photo" ? "" : "none";
  });
});

/* ================== MANUAL MODE ================== */
const itemsRoot = $("#items");
$("#addRow").addEventListener('click', addRow);
$("#clearAll").addEventListener('click', ()=>{ items=[]; renderItems(); renderSummary(); toast("Cleared."); });
$("#saveMeal").addEventListener('click', saveMeal);
$("#exportCsv").addEventListener('click', exportCsv);

function addRow(pref = {name:"", qty:100, unit:"g", kcal100:"", macros:null}){
  const id = crypto.randomUUID();
  const row = document.createElement('div');
  row.className="item"; row.dataset.id=id;

  // Food input with autocomplete
  const foodCell = document.createElement('div'); foodCell.className="autocomplete";
  const inp = document.createElement('input'); inp.className="input"; inp.placeholder="Type a food (e.g., paneer)";
  inp.setAttribute('autocomplete','off'); inp.value = pref.name||"";
  const sug = document.createElement('div'); sug.className="suggest";
  foodCell.append(inp, sug);

  // Amount
  const qtyCell = document.createElement('div');
  const qty = document.createElement('input'); qty.type="number"; qty.min="0"; qty.step="1"; qty.value=pref.qty||100; qty.className="input";
  qtyCell.append(qty);

  // Unit
  const unitCell = document.createElement('div');
  const unit = document.createElement('select'); unit.innerHTML = `<option value="g">g</option><option value="ml">ml</option><option value="piece">piece</option>`;
  unit.value = pref.unit||"g"; unit.className="input";
  unitCell.append(unit);

  // kcal/100g
  const kcalCell = document.createElement('div');
  const kcal100 = document.createElement('input'); kcal100.type="number"; kcal100.min="0"; kcal100.step="1"; kcal100.placeholder="(auto)"; kcal100.value=pref.kcal100||"";
  kcal100.className="input"; kcalCell.append(kcal100);

  // Remove
  const removeCell = document.createElement('div'); removeCell.className="remove";
  const rm = document.createElement('button'); rm.className="btn btn--ghost"; rm.textContent="Remove"; removeCell.append(rm);

  row.append(foodCell, qtyCell, unitCell, kcalCell, removeCell);
  itemsRoot.append(row);

  // item state
  items.push({id, name: inp.value.trim(), qty: +qty.value, unit: unit.value, kcal100: +kcal100.value || null, macros: pref.macros||null, kcal: 0});
  computeRow(id);

  // events
  rm.addEventListener('click', ()=>{ items = items.filter(x=>x.id!==id); row.remove(); renderSummary(); });
  qty.addEventListener('input', ()=>{ const it = items.find(x=>x.id===id); it.qty = +qty.value; computeRow(id); });
  unit.addEventListener('change', ()=>{ const it = items.find(x=>x.id===id); it.unit = unit.value; computeRow(id); });
  kcal100.addEventListener('input', ()=>{ const it = items.find(x=>x.id===id); it.kcal100 = +kcal100.value || null; computeRow(id); });

  // autocomplete
  const runSearch = debounce(async ()=>{
    const q = inp.value.trim();
    const container = sug;
    if(!q){ container.classList.remove('open'); container.innerHTML=""; return; }
    container.innerHTML = `<div class="skeleton">Searching…</div>`;
    container.classList.add('open');
    let results = [];
    const strat = SEARCH_STRATEGY();
    try{
      if(strat==="edamam"){
        const url = new URL("https://api.edamam.com/api/food-database/v2/parser");
        url.searchParams.set("app_id", CONFIG.EDAMAM_APP_ID);
        url.searchParams.set("app_key", CONFIG.EDAMAM_APP_KEY);
        url.searchParams.set("ingr", q);
        url.searchParams.set("category", "generic-foods");
        const r = await fetch(url); const j = await r.json();
        results = (j.hints||[]).slice(0,12).map(h=>({
          name: h.food.label,
          kcal: h.food.nutrients.ENERC_KCAL ?? 0,
          p: h.food.nutrients.PROCNT ?? 0,
          c: h.food.nutrients.CHOCDF ?? 0,
          f: h.food.nutrients.FAT ?? 0
        }));
      } else if(strat==="usda"){
        const url = new URL("https://api.nal.usda.gov/fdc/v1/foods/search");
        url.searchParams.set("api_key", CONFIG.USDA_API_KEY);
        url.searchParams.set("query", q);
        url.searchParams.set("pageSize","12");
        const r = await fetch(url); const j = await r.json();
        results = (j.foods||[]).map(f=>{
          const n=(k)=>{ const x=(f.foodNutrients||[]).find(n=>n.nutrientName?.includes(k)); return x?x.value:0; };
          return { name: f.description, kcal: n("Energy"), p:n("Protein"), c:n("Carbohydrate"), f:n("Total lipid") };
        });
      } else if(strat==="ninja"){
        const r = await fetch("https://api.api-ninjas.com/v1/nutrition?query="+encodeURIComponent(q), {headers:{'X-Api-Key': CONFIG.NINJAS_KEY}});
        const j = await r.json();
        results = j.slice(0,12).map(n=>({name:n.name, kcal:n.calories, p:n.protein_g, c:n.carbohydrates_total_g, f:n.fat_total_g}));
      } else {
        // local
        results = LOCAL_DB.foods
          .filter(f=> f.name.toLowerCase().includes(q.toLowerCase()))
          .slice(0,12)
          .map(f=>({name:f.name, kcal:f.kcal, p:f.p, c:f.c, f:f.f}));
      }
    }catch(e){ results=[]; }

    if(results.length===0){ container.innerHTML = `<div>No matches</div>`; return; }
    container.innerHTML = results.map(r=>`<div data-json='${JSON.stringify(r)}'>${r.name} <span class="badge" style="float:right">${fmt(r.kcal)} kcal/100g</span></div>`).join("");
    $$("div", container).forEach(opt=>{
      opt.addEventListener('click', ()=>{
        const data = JSON.parse(opt.dataset.json);
        inp.value = data.name;
        kcal100.value = Math.round(+data.kcal||0);
        const it = items.find(x=>x.id===id);
        it.name = data.name;
        it.kcal100 = +data.kcal||0;
        it.macros = {p:+data.p||0, c:+data.c||0, f:+data.f||0};
        container.classList.remove('open'); container.innerHTML="";
        computeRow(id);
      });
    });
  }, 220);

  inp.addEventListener('input', ()=>{
    const it = items.find(x=>x.id===id);
    it.name = inp.value.trim();
    runSearch();
  });
}

function computeRow(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  // Calculate kcal based on unit
  const amount = Number(it.qty)||0;
  const per100 = Number(it.kcal100)||0;
  let gramsEquiv = amount;
  if(it.unit==="ml"){ gramsEquiv = amount; } // assume density ~1g/ml unless API refines
  if(it.unit==="piece"){ gramsEquiv = amount*50; } // rough default; can be updated per-item after API select
  const kcal = per100 ? (gramsEquiv * per100 / 100) : 0;
  it.kcal = kcal;
  renderSummary();
}

function renderItems(){
  itemsRoot.innerHTML="";
  items.forEach(it=> addRow({name:it.name, qty:it.qty, unit:it.unit, kcal100:it.kcal100, macros:it.macros}));
}

function renderSummary(){
  const body = $("#summaryBody");
  if(items.length===0){ body.innerHTML = `<tr><td colspan="6" class="helper">Add foods to see totals.</td></tr>`; updateMacroBars(0,0,0); $("#tQty").textContent="—"; $("#tKcal").textContent="0"; $("#tP").textContent="0g"; $("#tC").textContent="0g"; $("#tF").textContent="0g"; return; }
  let tQty=0, tK=0, tP=0, tC=0, tF=0;
  body.innerHTML = items.map(it=>{
    const q = isFinite(+it.qty)? +it.qty : 0;
    const per = it.macros||{p:0,c:0,f:0};
    // approximate macros proportional to qty if kcal100 present
    let gramsEquiv = it.qty;
    if(it.unit==="piece") gramsEquiv = it.qty*50;
    if(it.unit==="ml") gramsEquiv = it.qty;
    const ratio = (isFinite(gramsEquiv) && gramsEquiv>0) ? gramsEquiv/100 : 0;
    const p = per.p*ratio, c = per.c*ratio, f = per.f*ratio;
    const kcal = it.kcal||0;
    tQty += q; tK += kcal; tP += p; tC += c; tF += f;
    return `<tr>
      <td>${it.name || '<span class="helper">Unnamed</span>'}</td>
      <td class="right">${q} ${it.unit}</td>
      <td class="right">${fmt(kcal)}</td>
      <td class="right">${fmt(p)}g</td>
      <td class="right">${fmt(c)}g</td>
      <td class="right">${fmt(f)}g</td>
    </tr>`;
  }).join("");
  $("#tQty").textContent = fmt(tQty);
  $("#tKcal").textContent = fmt(tK);
  $("#tP").textContent = fmt(tP)+"g";
  $("#tC").textContent = fmt(tC)+"g";
  $("#tF").textContent = fmt(tF)+"g";
  updateMacroBars(tP, tC, tF);
}

function updateMacroBars(P,C,F){
  const sum = Math.max(1, P+C+F);
  $("#macroP").style.width = Math.max(6, Math.round(P/sum*100))+"%";
  $("#macroC").style.width = Math.max(6, Math.round(C/sum*100))+"%";
  $("#macroF").style.width = Math.max(6, Math.round(F/sum*100))+"%";
}

function saveMeal(){
  if(items.length===0) return toast("Nothing to save.");
  const meal = {
    id: crypto.randomUUID(),
    at: new Date().toISOString(),
    items: JSON.parse(JSON.stringify(items)),
    totals: {
      qty: items.reduce((a,b)=>a + (+b.qty||0), 0),
      kcal: items.reduce((a,b)=>a + (+b.kcal||0), 0),
      p: items.reduce((a,b)=> a + (((b.macros?.p||0) * ((b.unit==="piece"? b.qty*50 : b.qty)/100))||0), 0),
      c: items.reduce((a,b)=> a + (((b.macros?.c||0) * ((b.unit==="piece"? b.qty*50 : b.qty)/100))||0), 0),
      f: items.reduce((a,b)=> a + (((b.macros?.f||0) * ((b.unit==="piece"? b.qty*50 : b.qty)/100))||0), 0),
    }
  };
  history.unshift(meal); history = history.slice(0,25);
  localStorage.setItem('calorie_history', JSON.stringify(history));
  renderHistory();
  toast("Meal saved.");
}

function exportCsv(){
  const rows = [["Food","Qty","Unit","kcal/100g","kcal","Protein(g)","Carbs(g)","Fat(g)"]];
  items.forEach(it=>{
    const gramsEquiv = it.unit==="piece"? it.qty*50 : it.qty;
    const ratio = gramsEquiv/100;
    const p = (it.macros?.p||0)*ratio, c=(it.macros?.c||0)*ratio, f=(it.macros?.f||0)*ratio;
    rows.push([it.name, it.qty, it.unit, it.kcal100||"", fmt(it.kcal||0), fmt(p), fmt(c), fmt(f)]);
  });
  const csv = rows.map(r=> r.map(csvEscape).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "meal.csv"; a.click();
}

/* ================== HISTORY ================== */
function renderHistory(){
  const root = $("#history");
  if(history.length===0){ root.innerHTML = `<div class="helper">No saved meals yet.</div>`; return; }
  root.innerHTML = history.map(m=>{
    const d = new Date(m.at);
    const title = d.toLocaleString();
    return `<div class="item" data-id="${m.id}">
      <div><b>${title}</b><div class="helper">${m.items.length} items</div></div>
      <div class="right"><span class="badge">${fmt(m.totals.kcal)} kcal</span></div>
      <div class="right">${fmt(m.totals.p)}g P</div>
      <div class="right">${fmt(m.totals.c)}g C</div>
      <div class="right">${fmt(m.totals.f)}g F</div>
    </div>`;
  }).join("");
  $$("#history .item").forEach(el=>{
    el.addEventListener('click', ()=>{
      const m = history.find(x=> x.id === el.dataset.id);
      if(!m) return;
      items = JSON.parse(JSON.stringify(m.items));
      itemsRoot.innerHTML=""; // rebuild
      items.forEach(it=> addRow(it));
      renderSummary();
      toast("Loaded meal into editor.");
    });
  });
}
renderHistory();

/* ================== INITIAL UI ================== */
addRow({name:"Boiled rice", qty:150, unit:"g", kcal100:130, macros:{p:2.7,c:28,f:0.3}});
addRow({name:"Dal (lentil curry)", qty:200, unit:"g", kcal100:116, macros:{p:9,c:20,f:0.4}});
renderSummary();

/* ================== PHOTO MODE ================== */
const video = $("#video"), canvas=$("#canvas"), openCam=$("#openCam"), snap=$("#snap");
const filePick=$("#filePick"), loader=$("#loader"), photoResults=$("#photoResults");
let stream = null;

openCam.addEventListener('click', async ()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
    video.srcObject = stream;
    video.style.display="block"; canvas.style.display="none";
  }catch(e){ toast("Camera blocked. Use Upload instead."); }
});

snap.addEventListener('click', ()=>{
  if(!video.srcObject){ toast("Open camera first, or Upload."); return; }
  const w = video.videoWidth, h = video.videoHeight;
  canvas.width=w; canvas.height=h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0,w,h);
  canvas.toBlob(async (blob)=>{ await analyzePhoto(blob); }, 'image/jpeg', 0.9);
  canvas.style.display="block"; video.style.display="none";
});

filePick.addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  await analyzePhoto(file);
});

async function analyzePhoto(blob){
  loader.classList.add('show');
  photoDetections = [];
  try{
    const strat = PHOTO_STRATEGY();
    if(strat==="caloriemama"){
      // Example CalorieMama-style endpoint (pseudo) — adjust to your provider docs.
      const r = await fetch("https://api-foreground.caloriemama.ai/food_recognize", {
        method:"POST",
        headers:{ "Authorization": CONFIG.CALORIEMAMA_KEY },
        body: (()=>{ const f=new FormData(); f.append("image", blob, "photo.jpg"); return f; })()
      });
      const j = await r.json();
      // Map results -> {name, kcal100, macros}
      const mapped = (j.results||[]).slice(0,8).map(it=>({
        name: it.name || it.food_name || "Detected item",
        // Many APIs return per-serving; normalize to per 100g when possible:
        kcal100: it.nutrition?.calories_per_100g ?? it.nutrition?.calories ?? 0,
        macros: {
          p: it.nutrition?.protein_g_per_100g ?? it.nutrition?.protein_g ?? 0,
          c: it.nutrition?.carbs_g_per_100g ?? it.nutrition?.carbs_g ?? 0,
          f: it.nutrition?.fat_g_per_100g ?? it.nutrition?.fat_g ?? 0,
        }
      }));
      photoDetections = mapped;
    } else {
      // Local demo model: very simple classifier by colors/edges (placeholder)
      // We’ll just simulate a few common items with confidence.
      await new Promise(r=> setTimeout(r, 900));
      photoDetections = [
        {name:"Rice (est.)", kcal100:130, macros:{p:2.7,c:28,f:0.3}},
        {name:"Chicken curry (est.)", kcal100:180, macros:{p:15,c:5,f:10}},
        {name:"Salad greens (est.)", kcal100:20, macros:{p:1.5,c:3,f:0.2}},
      ];
    }
    renderPhotoResults();
  }catch(e){
    toast("Error analyzing photo."); console.error(e);
  }finally{
    loader.classList.remove('show');
  }
}

function renderPhotoResults(){
  if(photoDetections.length===0){ photoResults.innerHTML = `<div class="helper">No items detected.</div>`; return; }
  photoResults.innerHTML = "";
  photoDetections.forEach((d,i)=>{
    const row = document.createElement('div');
    row.className = "item";
    row.innerHTML = `
      <div><b>${d.name}</b><div class="helper">per 100g</div></div>
      <div class="right">${fmt(d.kcal100)} kcal</div>
      <div class="right">${fmt(d.macros.p)}g P</div>
      <div class="right">${fmt(d.macros.c)}g C</div>
      <div class="right">${fmt(d.macros.f)}g F</div>
    `;
    photoResults.append(row);
  });
}

$("#addPhotoToMeal").addEventListener('click', ()=>{
  if(photoDetections.length===0) return toast("No photo items.");
  photoDetections.forEach(d=> addRow({name:d.name, qty:150, unit:"g", kcal100:d.kcal100, macros:d.macros}));
  renderSummary();
  toast("Added to meal.");
});
$("#clearPhoto").addEventListener('click', ()=>{ photoDetections=[]; photoResults.innerHTML=""; });

/* ================== ACCESSIBILITY & UX ================== */
document.addEventListener('keydown', (e)=>{
  if(e.key==="Escape"){ mobileMenu.classList.remove('open'); }
});
</script>
</body>
</html>
