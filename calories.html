
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calories & Nutrition Hub</title>
  <link rel="stylesheet" href="css/styles.css"/>
  <style>
    /* Page-specific */
    .hero-bar { padding:28px 0 18px; background: linear-gradient(90deg, var(--brand), var(--brand-2)); color:#071022; border-radius:12px; margin-bottom:18px; box-shadow:var(--shadow); }
    .camera-card { display:grid; gap:10px; grid-template-columns: 1fr 320px; align-items:start; }
    @media (max-width:860px){ .camera-card { grid-template-columns: 1fr; } }
    .camera-area { background:linear-gradient(180deg,#0f1530,#061022); border-radius:12px; padding:12px; border:1px solid #22305e; }
    video, canvas { width:100%; border-radius:10px; background:#071022; display:block; }
    .controls-row { display:flex; gap:8px; flex-wrap:wrap; }
    .estimate-result { background:linear-gradient(90deg,#0e1632,#071022); border-radius:10px; padding:12px; border:1px solid #22305e; color:var(--text); }
    .disclaimer { font-size:0.9rem; color:var(--muted); margin-top:8px; }
    .small-btn { padding:8px 12px; font-size:0.95rem; border-radius:10px; }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="container nav-inner">
      <a class="brand" href="index.html">
        <img src="assets/logo.png" alt="logo" width="120" onerror="this.onerror=null; this.src='logo.png'"/>
      </a>

      <div class="links" data-menu>
        <!-- removed 'Calories' link here because we're on this page -->
        <a class="link" href="weight-gain.html">Weight Gain</a>
        <a class="link" href="weight-loss.html">Weight Loss</a>
        <a class="link" href="exercises.html">Exercises</a>
        <a class="link" href="premium.html">Premium</a>
      </div>

      <button class="btn secondary" data-menu-btn>Menu</button>
    </div>
  </nav>

  <main class="container section">
    <div class="hero-bar">
      <h1 style="margin:0; font-size:28px">Calories & Nutrition Hub</h1>
      <p style="margin:6px 0 0" class="muted">BMR/TDEE, macros, BMI, water, meal plans ‚Äî plus a quick photo-based calorie estimator (demo).</p>
    </div>

    <!-- BMR & TDEE Calculator -->
    <div class="card fade-in">
      <h2>üí™ BMR & TDEE Calculator</h2>
      <div style="display:grid; gap:12px; grid-template-columns: 1fr 1fr;">
        <div>
          <label>Weight (kg):</label>
          <input id="weight" type="number" placeholder="Enter your weight">
        </div>
        <div>
          <label>Height (cm):</label>
          <input id="height" type="number" placeholder="Enter your height">
        </div>
        <div>
          <label>Age (years):</label>
          <input id="age" type="number" placeholder="Enter your age">
        </div>
        <div>
          <label>Gender:</label>
          <select id="gender"><option value="male">Male</option><option value="female">Female</option></select>
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:12px;align-items:center;">
        <div style="flex:1">
          <label>Activity Level:</label>
          <select id="activity">
            <option value="1.2">Sedentary</option>
            <option value="1.375">Lightly active</option>
            <option value="1.55">Moderately active</option>
            <option value="1.725">Very active</option>
            <option value="1.9">Extra active</option>
          </select>
        </div>
        <div style="width:220px;align-self:flex-end">
          <button class="btn" id="calcBtn">Calculate</button>
        </div>
      </div>
      <div id="result" class="result mt-2" style="display:none"></div>
    </div>

    <!-- Camera / Photo-based estimator -->
    <div class="card fade-in mt-3">
      <h2>üì∏ Photo-based Calorie Estimator (Demo)</h2>
      <p class="muted small">Take a photo of your plate or upload an image. The site runs a demo heuristic estimator in the browser and provides an approximate calorie range. For accurate results use a trained model (see notes below).</p>

      <div class="camera-card mt-2">
        <div class="camera-area">
          <div style="display:flex;gap:10px;align-items:center;">
            <button class="btn small-btn" id="startCameraBtn">Open Camera</button>
            <button class="btn small-btn secondary" id="stopCameraBtn">Stop Camera</button>
            <label class="btn small-btn ghost" style="padding:8px 10px; cursor:pointer;">
              Upload Image
              <input id="uploadInput" type="file" accept="image/*" style="display:none">
            </label>
            <button class="btn small-btn" id="captureBtn">Capture Photo</button>
            <button class="btn small-btn" id="estimateBtn">Estimate Calories</button>
          </div>

          <div style="margin-top:10px;">
            <video id="cameraVideo" autoplay playsinline style="display:none; border-radius:8px;"></video>
            <canvas id="captureCanvas" style="display:none; border-radius:8px;"></canvas>
            <img id="previewImg" src="" alt="Preview" style="display:none; width:100%; border-radius:8px; margin-top:10px;">
          </div>

          <div id="estInfo" class="estimate-result mt-2" style="display:none"></div>
          <div class="disclaimer">This is an approximate, demo estimate. Actual calories depend on ingredients, portion, and preparation. See the comments at the bottom to integrate a real ML model.</div>
        </div>

        <!-- Right column: quick manual controls -->
        <div>
          <div class="card">
            <h3>Manual Adjust</h3>
            <label>Food type (use for better estimate):</label>
            <select id="manualFood">
              <option value="auto">Auto-detect (demo)</option>
              <option value="salad">Salad / Veg (low)</option>
              <option value="carb">Carb-heavy (rice, pasta)</option>
              <option value="protein">Protein-heavy (meat, fish)</option>
              <option value="dessert">Dessert (high)</option>
            </select>

            <label class="mt-2">Portion multiplier</label>
            <input id="portionRange" type="range" min="0.25" max="3" step="0.05" value="1">

            <div class="muted small mt-2">Preview multiplier: <span id="portionValue">1.00x</span></div>

            <div style="margin-top:14px;">
              <button class="btn" id="manualEstimateBtn">Manual Estimate</button>
              <button class="btn secondary" id="clearPhotoBtn">Clear Photo</button>
            </div>
          </div>
        </div>
      </div>

      <div class="muted small mt-2">
        <strong>About this demo:</strong> to integrate a real image‚Üícalorie solution you can:
        <ol>
          <li>Use a food-image classifier + caloric lookup table on the server, or</li>
          <li>Use TensorFlow.js with a trained model (MobileNet fine-tuned) to classify food type, then estimate calories using portion area.</li>
        </ol>
      </div>
    </div>

    <!-- Macros / BMI / Water / Meal plan (original features preserved) -->
    <div class="card fade-in mt-3">
      <h2>üçΩÔ∏è Macronutrient Breakdown</h2>
      <p class="muted">Based on your calculated calories, get recommended protein, carbs and fats.</p>
      <div style="display:flex;gap:10px;">
        <button class="btn" id="macroBtn">Show Macronutrients</button>
        <div id="macrosResult" class="result" style="display:none"></div>
      </div>
    </div>

    <div class="card fade-in mt-3">
      <h2>‚öñÔ∏è BMI Calculator</h2>
      <div style="display:flex;gap:10px;align-items:flex-end;">
        <div style="flex:1"><label>Weight (kg)</label><input id="bmiWeight" type="number"></div>
        <div style="flex:1"><label>Height (cm)</label><input id="bmiHeight" type="number"></div>
        <div style="width:220px"><button class="btn" id="bmiBtn">Calculate BMI</button></div>
      </div>
      <div id="bmiResult" class="result mt-2" style="display:none"></div>
    </div>

    <div class="card fade-in mt-3">
      <h2>üíß Daily Water Intake</h2>
      <div style="display:flex;gap:10px;align-items:center;">
        <input id="waterWeight" type="number" placeholder="Weight (kg)">
        <button class="btn" id="waterBtn">Calculate Water</button>
      </div>
      <div id="waterResult" class="result mt-2" style="display:none"></div>
    </div>

    <div class="card fade-in mt-3">
      <h2>ü•ó Meal Plan Generator</h2>
      <label>Diet Preference:</label>
      <select id="dietType">
        <option value="veg">Vegetarian</option>
        <option value="nonveg">Non-Vegetarian</option>
      </select>
      <div style="margin-top:10px;">
        <button class="btn" id="mealBtn">Generate Meal Plan</button>
        <button class="btn secondary" id="copyMealBtn" style="display:none">Copy Meal Plan</button>
      </div>
      <div id="mealPlanResult" class="result mt-2" style="display:none; white-space:pre-wrap"></div>
    </div>

  </main>

  <script src="js/ui.js"></script>

  <script>
  (function(){
    // safe fallbacks
    if (typeof showToast !== 'function') window.showToast = function(m,t){ alert(m); };
    if (typeof showModal !== 'function') window.showModal = function(t,c){ alert(t + "\\n\\n" + (c.replace(/<[^>]+>/g,''))); };
    if (typeof triggerFadeIn !== 'function') window.triggerFadeIn = function(){ document.querySelectorAll('.fade-in').forEach(e=>e.classList.add('visible')); };

    // ---------- calculator logic (same as earlier pages) ----------
    let latestCalories = null;
    document.getElementById('calcBtn').addEventListener('click', ()=>{
      const weight = parseFloat(document.getElementById('weight').value);
      const height = parseFloat(document.getElementById('height').value);
      const age = parseFloat(document.getElementById('age').value);
      const gender = document.getElementById('gender').value;
      const activity = parseFloat(document.getElementById('activity').value);

      if(!weight || !height || !age){ showToast('Please fill all fields!', 'error'); return; }

      const bmr = (gender === 'male') ? (10*weight + 6.25*height - 5*age + 5) : (10*weight + 6.25*height - 5*age - 161);
      const tdee = Math.round(bmr * activity);
      const deficit = tdee - 500;
      const surplus = tdee + 500;
      latestCalories = tdee;

      document.getElementById('result').style.display = 'block';
      document.getElementById('result').innerHTML = `
        Maintenance Calories: <b>${tdee} kcal</b><br>
        Calories for Weight Loss: <b>${deficit} kcal</b><br>
        Calories for Weight Gain: <b>${surplus} kcal</b>
      `;
      showToast('Calories calculated', 'success');
    });

    // macros
    document.getElementById('macroBtn').addEventListener('click', ()=>{
      if(!latestCalories){ showToast('Please calculate calories first!', 'error'); return; }
      const protein = Math.round(latestCalories * 0.3 / 4);
      const carbs = Math.round(latestCalories * 0.45 / 4);
      const fats = Math.round(latestCalories * 0.25 / 9);
      document.getElementById('macrosResult').style.display = 'block';
      document.getElementById('macrosResult').innerHTML = `Protein: <b>${protein} g</b><br>Carbs: <b>${carbs} g</b><br>Fats: <b>${fats} g</b>`;
    });

    // BMI
    document.getElementById('bmiBtn').addEventListener('click', ()=>{
      const w = parseFloat(document.getElementById('bmiWeight').value);
      const h = parseFloat(document.getElementById('bmiHeight').value)/100;
      if(!w || !h){ showToast('Please fill all fields!', 'error'); return; }
      const bmi = (w/(h*h)).toFixed(1);
      const cat = bmi < 18.5 ? 'Underweight' : bmi < 24.9 ? 'Normal weight' : bmi < 29.9 ? 'Overweight' : 'Obese';
      document.getElementById('bmiResult').style.display='block';
      document.getElementById('bmiResult').innerHTML = `BMI: <b>${bmi}</b> (${cat})`;
    });

    // Water
    document.getElementById('waterBtn').addEventListener('click', ()=>{
      const w = parseFloat(document.getElementById('waterWeight').value);
      if(!w){ showToast('Please enter weight!', 'error'); return; }
      const water = (w * 35 / 1000).toFixed(1);
      document.getElementById('waterResult').style.display='block';
      document.getElementById('waterResult').innerHTML = `Recommended Water Intake: <b>${water} L/day</b>`;
    });

    // Meal plan
    document.getElementById('mealBtn').addEventListener('click', ()=>{
      if(!latestCalories){ showToast('Calculate calories first!', 'error'); return; }
      const diet = document.getElementById('dietType').value;
      const calories = latestCalories;
      const breakfast = Math.round(calories * 0.25);
      const lunch = Math.round(calories * 0.35);
      const dinner = Math.round(calories * 0.3);
      const snacks = Math.round(calories * 0.1);
      let meal = '';
      if(diet === 'veg'){
        meal = `Breakfast (~${breakfast} kcal):\n- Oats with milk, banana, nuts\n\nLunch (~${lunch} kcal):\n- 2-3 chapatis + veg curry + dal\n\nDinner (~${dinner} kcal):\n- Veg pulao + paneer curry\n\nSnacks (~${snacks} kcal):\n- Nuts, fruit`;
      } else {
        meal = `Breakfast (~${breakfast} kcal):\n- Eggs (2-3) + toast\n\nLunch (~${lunch} kcal):\n- Grilled chicken/fish + rice/chapati\n\nDinner (~${dinner} kcal):\n- Chicken/fish curry + rice/chapati\n\nSnacks (~${snacks} kcal):\n- Nuts, fruit`;
      }
      document.getElementById('mealPlanResult').style.display='block';
      document.getElementById('mealPlanResult').innerText = meal;
      document.getElementById('copyMealBtn').style.display='inline-block';
    });
    document.getElementById('copyMealBtn').addEventListener('click', ()=>{
      const meal = document.getElementById('mealPlanResult').innerText;
      navigator.clipboard.writeText(meal).then(()=> showToast('Meal plan copied!', 'success')).catch(()=> showToast('Copy failed', 'error'));
    });

    // ---------- Camera & Image estimator ----------
    const startCameraBtn = document.getElementById('startCameraBtn');
    const stopCameraBtn = document.getElementById('stopCameraBtn');
    const captureBtn = document.getElementById('captureBtn');
    const estimateBtn = document.getElementById('estimateBtn');
    const uploadInput = document.getElementById('uploadInput');
    const previewImg = document.getElementById('previewImg');
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('captureCanvas');
    const estInfo = document.getElementById('estInfo');
    const manualFood = document.getElementById('manualFood');
    const portionRange = document.getElementById('portionRange');
    const portionValue = document.getElementById('portionValue');
    const manualEstimateBtn = document.getElementById('manualEstimateBtn');
    const clearPhotoBtn = document.getElementById('clearPhotoBtn');

    let stream = null;
    let latestImageDataUrl = null;

    function stopStream(){
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; video.style.display='none'; }
    }

    startCameraBtn.addEventListener('click', async ()=>{
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
        video.srcObject = stream;
        video.style.display = 'block';
        previewImg.style.display = 'none';
        showToast('Camera started', 'info');
      } catch(e){
        showToast('Camera access denied or not available. Use upload instead.', 'error');
      }
    });

    stopCameraBtn.addEventListener('click', ()=>{
      stopStream();
      showToast('Camera stopped', 'info');
    });

    captureBtn.addEventListener('click', ()=>{
      // capture from video if available; otherwise nothing
      if (video && video.srcObject){
        const w = video.videoWidth || 640;
        const h = video.videoHeight || 480;
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, w, h);
        latestImageDataUrl = canvas.toDataURL('image/jpeg', 0.9);
        previewImg.src = latestImageDataUrl;
        previewImg.style.display = 'block';
        showToast('Photo captured', 'success');
      } else {
        showToast('Camera not active. Use upload or start camera.', 'error');
      }
    });

    uploadInput.addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        latestImageDataUrl = ev.target.result;
        previewImg.src = latestImageDataUrl;
        previewImg.style.display = 'block';
        showToast('Image loaded', 'success');
      };
      reader.readAsDataURL(f);
    });

    portionRange.addEventListener('input', ()=> { portionValue.textContent = parseFloat(portionRange.value).toFixed(2) + 'x'; });

    // Clear photo
    clearPhotoBtn.addEventListener('click', ()=>{
      latestImageDataUrl = null;
      previewImg.src = '';
      previewImg.style.display = 'none';
      estInfo.style.display = 'none';
      stopStream();
      showToast('Cleared photo', 'info');
    });

    // Estimate calories (demo heuristic)
    async function estimateCaloriesFromImage(dataUrl, manualType='auto', portion=1.0){
      // Simple client-side heuristic:
      // 1. downscale to 200x200, compute average RGB and non-white pixel ratio (coverage)
      // 2. decide category by dominant color (green->veg, red/brown->protein, yellow->carb, bright->dessert)
      // 3. base calories per portion by category (veg:200-350, carb:400-600, protein:450-700, dessert:300-900)
      // 4. result = base * coverage * portion (coverage 0.2..1.0)
      if(!dataUrl) throw new Error('No image');

      return new Promise((resolve)=>{
        const img = new Image();
        img.onload = function(){
          const w = 200, h = Math.round(200 * (img.height / img.width || 1));
          const tmp = document.createElement('canvas');
          tmp.width = w; tmp.height = h;
          const ctx = tmp.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          const pixels = ctx.getImageData(0,0,w,h).data;
          let rSum=0,gSum=0,bSum=0, count=0, nonwhite=0;
          for(let i=0;i<pixels.length;i+=4){
            const r=pixels[i], g=pixels[i+1], b=pixels[i+2];
            rSum+=r; gSum+=g; bSum+=b; count++;
            // treat 'non-white' threshold
            if(!(r>240 && g>240 && b>240)) nonwhite++;
          }
          const avgR = rSum/count, avgG = gSum/count, avgB = bSum/count;
          const coverage = Math.max(0.05, Math.min(1, nonwhite / count)); // 0.05..1

          // decide category
          let cat = 'unknown';
          if (manualType && manualType !== 'auto') cat = manualType;
          else {
            if (avgG > avgR + 12 && avgG > avgB + 12) cat = 'salad'; // green
            else if (avgR > avgG + 8 && avgR > avgB - 10) cat = 'protein'; // red/brown
            else if (avgB > avgR && avgB > avgG) cat = 'dessert';
            else if (avgR > 150 && avgG > 120 && avgB < 120) cat = 'carb';
            else cat = 'protein';
          }

          let baseMin=300, baseMax=500;
          switch(cat){
            case 'salad': baseMin=120; baseMax=350; break;
            case 'carb': baseMin=350; baseMax=700; break;
            case 'protein': baseMin=400; baseMax=800; break;
            case 'dessert': baseMin=300; baseMax=1000; break;
            default: baseMin=300; baseMax=700;
          }

          // portion and coverage influence
          const estLow = Math.round(baseMin * coverage * portion);
          const estHigh = Math.round(baseMax * coverage * portion);

          resolve({ category: cat, coverage: coverage, avgColor:{r:avgR,g:avgG,b:avgB}, estimate:{low:estLow, high:estHigh} });
        };
        img.onerror = function(){ resolve(null); };
        img.src = dataUrl;
      });
    }

    estimateBtn.addEven
